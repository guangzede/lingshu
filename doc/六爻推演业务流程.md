# 六爻推演业务主流程梳理

本说明文档梳理了从“点击开始推演”到六爻结果渲染的完整业务流程，涵盖主要逻辑流转、核心数据结构与关键函数。

---

## 1. 用户操作入口

- 用户在 `/pages/Liuyao/divination/index.tsx` 页面，选择起卦模式（手动、报数、自动、摇卦）。
- 填写/选择时间、报数、事项等信息。
- 点击“开始推演”按钮，触发 `handlePaipan`（`usePaipan` hook）。

## 2. 起卦与排盘

- `handlePaipan` 根据当前模式：
  - 手动：直接调用 `compute()`。
  - 报数：`applyCountMethod` 解析报数，设置每一爻的阴阳动静，再调用 `compute()`。
  - 自动：`applyAutoMethod` 随机生成六爻，再调用 `compute()`。
- `compute()`（store/liuyao.ts）会：
  - 读取当前 lines（六爻阴阳动静数组）、时间、规则等。
  - 调用 `computeAll`（services/liuyao/core.ts）进行核心排盘。
  - 结果写入 store 的 `result` 字段。

## 3. 核心排盘逻辑（computeAll）

- 主要步骤：
  1. 构建本卦（`buildHexagram`），并生成变卦（`deriveVariant`）。
  2. 纳甲、六神分配（`mapNaJia`、`assignSixGods`）。
  3. 判定六亲、长生、五行、旺衰等（`getRelation`、`assignChangsheng`、`assignFiveElement`、`seasonStatus`）。
  4. 计算神煞、旬空等（`computeShenSha`、`computeXunKong`）。
  5. 汇总所有信息，返回完整结果对象（含本卦、变卦、六爻详细、干支、五行、神煞等）。

## 4. 跳转与结果渲染

- 排盘完成后，页面跳转到 `/pages/Liuyao/result/index.tsx`。
- 结果页通过 `useLiuyaoStore` 读取 `result`，并渲染：
  - 卦象表格（`HexagramTable`）
  - 五行能量（`FiveElementsAnalysis`）
  - 干支关系（`BranchRelation`）
  - 爻位动态分析（`YaoAnalysis`，调用 `analyzeYaoInteractions`、`analyzeYao`）
  - AI 分析、人工答疑、专业分析等卡片

## 5. 关键数据流与函数

- `lines`：六爻阴阳动静数组，贯穿起卦、排盘、渲染全流程。
- `result`：排盘结果对象，包含所有分析数据。
- `computeAll`：核心业务函数，负责所有六爻推演与分析。
- `analyzeYao`/`analyzeYaoInteractions`：爻位关系与动态分析。

---

## 6. 典型流程时序图

1. 用户点击“开始推演”
2. → `handlePaipan`（模式分流）
3. → `setLineState`（如需）
4. → `compute()`
5. → `computeAll()`
6. → 结果写入 store
7. → 跳转到结果页
8. → 结果页各分析卡片读取并渲染 `result`

---

## 7. 参考文件
- `/pages/Liuyao/divination/index.tsx`（入口页）
- `/pages/Liuyao/hooks/usePaipan.ts`（排盘逻辑）
- `/store/liuyao.ts`（状态管理与 compute）
- `/services/liuyao/core.ts`（核心推演）
- `/pages/Liuyao/result/index.tsx`（结果页）
- `/pages/Liuyao/result/components/YaoAnalysis/index.tsx`（爻分析）
- `/pages/Liuyao/hooks/useYaoAnalysis.ts`（爻分析逻辑）

---

如需详细代码注释或流程图可进一步补充。